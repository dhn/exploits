FROM phusion/baseimage:latest
MAINTAINER Dennis Herrmann <dhn@zer0-day.pw>

# install debian stuff
RUN apt-get -y update && \
	DEBIAN_FRONTEND=noninteractive apt-get install -y \
    wget \
	netcat \
    xz-utils \
    make \
    gcc \
    libpcre++-dev \
    libdb-dev \
    libxt-dev \
    libxaw7-dev \
    tzdata \
	telnet && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /work 

COPY data/conf.conf /work/
COPY data/buildconfig.c /work/
COPY exploit.sh /tmp/

RUN wget https://github.com/Exim/exim/releases/download/exim-4_89/exim-4.89.tar.xz && \
    tar xf exim-4.89.tar.xz && cd exim-4.89 && \
	ls && cp /work/buildconfig.c src/ && \
    cp src/EDITME Local/Makefile && cp exim_monitor/EDITME Local/eximon.conf && \
    sed -i 's/^EXIM_USER=/EXIM_USER=root/' Local/Makefile && \
    useradd exim && make && make install && mkdir -p /var/spool/exim/log && \
	mkdir -p /var/spool/exim/input/ && chown -R exim:exim /var/spool/exim && \
    cd /var/spool/exim/log && touch mainlog paniclog rejectlog && \
    chown exim mainlog paniclog rejectlog

COPY main.sh /
ENTRYPOINT ["/main.sh"]
CMD ["default"]
